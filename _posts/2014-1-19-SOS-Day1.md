---
layout: post
title: Day1
tags:
  - SOS
---

Mac 里已经自带了 nasm 等相关的工具, 所以还是从 helloworld 开始, 就不用书上 nask 那个编译器了.
今天先了解与引导扇区相关的东西.
<!-- more -->
下面是一段 boot sector 的汇编代码.
```asm
	org	07c00h
	mov	ax, cs
	mov	ds, ax
	mov	es, ax
	call	ShowStr
	jmp	$					;无限循环, 后面会用 hlt 来代替
ShowStr:
	mov	ax, BootMessage
	mov	bp, ax
	mov	cx, 12				;字符串长度
	mov	ax, 01301h
	mov	bx, 000ch			;bh = 0 页号, bl ＝ 0ch, 黑底红字
	mov	dl, 0
	int	10h
	ret
BootMessage:
	db	"Hello World!"
times	510-($-$$) db	0	;填充剩余空间使得生成文件为 512 字节
	dw	0xaa55
```
接下来编译文件.
```
nasm helloworld.asm -o boot.bin
cat boot.bin|hexdump
```
可以看到文件末尾为 `55aa`. 接下来是写入引导扇区就行了.
1.44MB 的软盘有 2880 个扇区, 每个扇区 512 字节, 0 扇区为引导扇区, 包含引导记录、分区表等信息, 用以下命令创建镜像文件
```
dd bs=512 count=2880 if=/dev/zero of=boot.img
dd conv=notrunc if=boot.bin of=boot.img
```
然后创建虚拟机, 从这个软盘镜像启动就能看到 `Hello World!`
要写入虚拟光盘文件方法类似, 使用 `HDIUTIL create -help` 查看帮助.
其实到这里只是完成了一个简单的 boot sector 而已 (´･_･`) 接下来的明天继续吧.